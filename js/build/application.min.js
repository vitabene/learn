/* Vitezslav Benes 2015*/

function round(a,b){return Math.round(a*Math.pow(10,b))/Math.pow(10,b)}function byTag(a){return document.getElementsByTagName(a)}function byClassName(a){return document.getElementsByClassName(a)}function byId(a){return document.getElementById(a)}function shuffleArray(a){for(var b,c,d=a.length;d;b=Math.floor(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a}function getChildrenOfId(a){for(var b=byId(a).childNodes,c=[],d=-1,e=b.length;++d!==e;c[d]=b[d]);return c}function clearClass(a){var b=byClassName(a);if(0!==b.length)for(var c=b.length-1;c>=0;c--)b[c].className=b[c].className.replace(a,"")}function removeNodesWithClass(a){for(var b=document.getElementsByClassName(a);b[0];)b[0].parentNode.removeChild(b[0])}function arrayFromCollection(a){for(var b=[],c=0;c<a.length;c++){var d=[];d.push(a[c].dataset.a),d.push(a[c].dataset.b),b.push(d)}return b}function removeAllChildren(a){for(var b=byId(a);b.firstChild;)b.removeChild(b.firstChild)}function isKey(a){return"k"===a.id.substring(0,1)?!0:!1}function findKey(a,b){for(var c=0;c<a.length;c++)if(a[b])return a[b];return!1}function randomIndexesFromDB(a,b,c){for(var d=[];a!==d.length;){var e=Math.floor(Math.random()*b.length);-1===d.indexOf(e)&&-1===c.indexOf(e)&&(d.push(e),c.push(e))}return d}function pairArrayFromIndexes(a,b){for(var c=[],d=0;d<a.length;d++){var e=1,f=b[a[d]];f.length>2&&(e=Math.floor(Math.random()*(f.length-1))+1);var g=new Pair(b[a[d]][0],b[a[d]][e]);c.push(g)}return c}function Pair(a,b){this.keyNode=this.createLiNode(a),this.valueNode=this.createLiNode(b),this.assignedValue,this.mistakes}Pair.prototype.createLiNode=function(a){var b=document.createElement("li");return b.innerHTML=a,b},Pair.prototype.check=function(){return this.valueNode.innerHTML===this.assignedValue?(this.markCorrect(),this.moveUp(),!0):(this.highlightMistake(),!1)},Pair.prototype.moveUp=function(){var a=this.keyNode.parentNode,b=this.valueNode.parentNode;a.removeChild(this.keyNode),b.removeChild(this.valueNode),a.insertBefore(this.keyNode,a.childNodes[0]),b.insertBefore(this.valueNode,b.childNodes[0])},Pair.prototype.markCorrect=function(){this.keyNode.className="correct",this.valueNode.className="correct"},Pair.prototype.highlightMistake=function(){this.keyNode.className="mistake",this.valueNode.className="mistake"};var App={pairDatabase:[],pairsGenerated:5,pairsInUse:[],indexesUsed:[],indexesLeft:0,lineNodes:[],lineParent:{},mistakes:[],correct:0,startButton:{},checkButton:{},message:{},time:0};App.populateDatabase=function(a){if(""==a)return void console.log("no arg passed");xmlhttp=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");return xmlhttp.onreadystatechange=function(){if(4==xmlhttp.readyState&&200==xmlhttp.status){var a=JSON.parse(xmlhttp.responseText);Object.keys(a).map(function(b){var c=Array(b).concat(a[b]);App.pairDatabase.push(c)}),App.indexesLeft=App.pairDatabase.length}},xmlhttp.open("GET","getpairs.php?id="+a,!0),xmlhttp.send(),!0},App.generatePairs=function(){var a=App.pairsGenerated,b=[],c=[];App.indexesLeft<a&&(a=App.indexesLeft),App.indexesLeft-=a,App.refresh(),App.lineParent.removeChild(App.checkButton),App.pairDatabase.length<App.pairsGenerated&&(App.pairsGenerated=App.pairDatabase.length),indexesFromDB=randomIndexesFromDB(a,App.pairDatabase,App.indexesUsed),App.pairsInUse=pairArrayFromIndexes(indexesFromDB,App.pairDatabase);for(var d=0;d<App.pairsInUse.length;d++)b.push(App.pairsInUse[d].valueNode);b=shuffleArray(b);var e=0,f=0;for(d=0;a>d;d++){var g=App.pairsInUse[d].keyNode,h=b[d];g.id="k"+d,c[g.id]=App.pairsInUse[d],byId("leftcol").appendChild(g),byId("rightcol").appendChild(h),0===d&&(f=h.getBoundingClientRect().top),e=h.getBoundingClientRect().bottom}return App.pairsInUse=c,App.lineParent.style.height=20+e+"px",App.checkButton.style.marginTop=e-f+50+"px",App.lineParent.appendChild(App.checkButton),!0},App.notify=function(a){return App.message=document.createElement("div"),text=document.createElement("span"),removeButton=document.createElement("span"),App.message.id="message",text.innerHTML=a,removeButton.id="remove-message",removeButton.innerHTML="X",App.message.appendChild(text),App.message.appendChild(removeButton),App.messageParent.insertBefore(App.message,App.messageParent.firstChild),removeButton.addEventListener("click",function(){App.messageParent.removeChild(this.parentNode),App.message={}}),!0},App.connect=function(a){if("selected"!==a.className?a.className="selected":a.removeAttribute("class"),isKey(a)&&App.lineNodes.key?App.lineNodes.key.removeAttribute("class"):!isKey(a)&&App.lineNodes.value&&App.lineNodes.value.removeAttribute("class"),a.id){var b=a.id.substring(a.id.length-1),c="l"+b,d="v"+b;byId(c)&&byId(c).parentNode.removeChild(byId(c)),byId(d)&&byId(d).removeAttribute("id")}if(isKey(a)?App.lineNodes.key=a:App.lineNodes.value=a,App.lineNodes.key&&App.lineNodes.value){var e=App.pairsInUse[App.lineNodes.key.id];e.assignedValue=App.lineNodes.value.innerHTML,App.lineParent.insertBefore(App.createLine(),App.checkButton),setTimeout(function(){clearClass("selected")},300),App.lineNodes=[]}return!0},App.refresh=function(){return App.lineNodes=[],App.pairsInUse=[],removeAllChildren("rightcol"),removeAllChildren("leftcol"),!0},App.sendDataTo=function(a,b){var c=document.createElement("form");c.method=b,c.action=a;for(var d=[],e=0;4>e;e++)d[e]=document.createElement("input");d[0].name="num_of_mistakes",d[0].value=App.mistakes.length,d[1].name="num_of_pairs",d[1].value=App.pairDatabase.length,d[2].name="time",d[2].value=App.time,d[3].name="set_id",d[3].value=App.lineParent.dataset.set,d[4]=document.createElement("button"),d[4].type="submit";for(var e=d.length-1;e>=0;e--)c.appendChild(d[e]);c.style.display="none",App.lineParent.appendChild(c),c.submit()},App.createLine=function(){var a=App.lineNodes.key,b=App.lineNodes.value,c=[a.getBoundingClientRect(),b.getBoundingClientRect(),App.lineParent.getBoundingClientRect()],d=c[0].bottom-c[0].top,e={x:c[0].right,y:c[0].top+d/2},f={x:c[1].left,y:c[1].top+d/2},g={x:f.x-e.x,y:f.y-e.y},h=Math.sqrt(Math.pow(g.x,2)+Math.pow(g.y,2)),i=Math.asin(g.y/h)*(180/Math.PI),j={x:e.x+(g.x-h)/2-c[2].left,y:e.y+g.y/2-c[2].top},k=document.createElement("span");k.className="line";var l=function(a){a.style.width=round(h-1,1)+"px",a.style.marginTop=round(j.y,1)+"px",a.style.marginLeft=round(j.x+1,1)+"px",0!==i&&(a.style.webkitTransform=a.style.MozTransform=a.style.msTransform=a.style.OTransform=a.style.transform="rotate("+round(i,1)+"deg)")};l(k);var m=a.id;return k.id="l"+m.substring(m.length-1),b.id="v"+m.substring(m.length-1),k},App.checkPairs=function(){var a=byClassName("line");if(a.length+App.correct>=App.pairsGenerated){for(var b=[],c=Object.keys(App.pairsInUse),d=byId("rightcol"),e=0;e<c.length;e++){var f=App.pairsInUse[c[e]];"correct"!==f.keyNode.className&&(f.check()?App.correct++:b.push(f))}for(var e=0;e<d.childNodes.length;e++)d.childNodes[e].removeAttribute("id");0===App.mistakes.length?App.mistakes=b.slice():Object.keys(b).map(function(a){-1===App.mistakes.indexOf(b[a])&&App.mistakes.push(b[a])}),0===b.length?setTimeout(function(){0===App.indexesLeft&&(App.time=Math.floor(((new Date).getTime()-App.time)/1e3),App.sendDataTo("results.php","post")),App.generatePairs()},1e3):setTimeout(function(){clearClass("mistake")},1e3),removeNodesWithClass("line")}else App.message.childNodes||App.notify("Please connect all bubbles.");return!0},App.getScore=function(){var a=App.pairDatabase.length,b=App.mistakes.length,c="Your score is "+round((a-b)/a*100,2)+" % = "+(a-b)+" / "+a;return c},App.getJSONMistakes=function(){for(var a={},b=0;b<App.mistakes.length;b++){var c=App.mistakes[b],d=[];d[0]=c.keyNode.innerHTML,d[1]=c.valueNode.innerHTML,d[2]=c.assignedValue,d=d.join(),console.log(d),a[b]=d}return console.log(JSON.stringify(a)),JSON.stringify(a)},App.init=function(){return App.messageParent=byTag("main")[0],App.lineParent=byId("pair-list"),App.populateDatabase(App.lineParent.dataset.set),App.startButton=document.createElement("button"),App.checkButton=document.createElement("button"),App.startButton.innerHTML="start",App.startButton.style.marginBottom="50px",App.checkButton.innerHTML="check",App.lineParent.appendChild(App.startButton),App.lineParent.addEventListener("click",function(a){a.target&&("LI"===a.target.nodeName?App.connect(a.target):a.target===App.startButton?(removeNodesWithClass("heading"),App.startButton.style.display="none",App.lineParent.appendChild(App.checkButton),App.generatePairs(),App.time=(new Date).getTime()):a.target===App.checkButton&&App.checkPairs())},!1),!0},document.addEventListener("DOMContentLoaded",App.init);
//# sourceMappingURL=application.min.js.map